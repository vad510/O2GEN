@model O2GEN.Models.MaximoStatisticsFilter
@{ ViewData["Title"] = "Деффекты"; }

<section class="">
    <div id="placeholder"></div>
    <div class="row-container-left bg-blue" id="pageToolbar" style="position:sticky">
        <form action="MaximoStatistics" method="post">

            <input asp-for="From" style="display:none" />
            <input asp-for="To" style="display:none" />
            <div class="d-flex flex-wrap m-2">
                <div class="mb-2 mr-2">
                    <button class="btn btn-light" type="button" id="SetToday">
                        <i class="fa fa-calendar-day"></i>
                        Сегодня
                    </button>
                </div>
                <span class="li-text-white mr-0 mb-2">От:</span>
                <div class="mb-2 mr-2">
                    <div class="input-group date col-auto" id="datetimepickerFROM" data-target-input="nearest">
                        <input type="text" class="form-control datetimepicker-input" data-target="#datetimepickerFROM" id="DTPFROM" style="width:150px;" />
                        <div class="input-group-append" data-target="#datetimepickerFROM" data-toggle="datetimepicker">
                            <div class="input-group-text"><i class="fa fa-calendar"></i></div>
                        </div>
                    </div>
                </div>
                <span class="li-text-white mr-0 mb-2">До:</span>
                <div class="mb-2 mr-2">
                    <div class="input-group date col-auto" id="datetimepickerTO" data-target-input="nearest">
                        <input type="text" class="form-control datetimepicker-input" data-target="#datetimepickerTO" id="DTPTO" style="width:150px;" />
                        <div class="input-group-append" data-target="#datetimepickerTO" data-toggle="datetimepicker">
                            <div class="input-group-text"><i class="fa fa-calendar"></i></div>
                        </div>
                    </div>
                </div>

                <div class="mb-2 mr-2">
                    <select asp-for="DepartmentId" class="form-control" required>
                        <option value="NULL" selected>Выбрать подразделение</option>
                        @foreach (Department item in O2GEN.Helpers.DBHelper.GetChildDepartments())
                        {
                            <option value="@item.Id">@item.DisplayName</option>
                        }
                    </select>
                </div>

                <div class="mb-2 mr-2">
                    <select asp-for="MaximoStatusId" class="form-control" required>
                        <option value="NULL" selected>Все</option>
                        @foreach (MaximoStatus item in O2GEN.Helpers.DBHelper.GetMaximoStatuses())
                        {
                            <option value="@item.Id">@item.DisplayName</option>
                        }
                    </select>
                </div>
                <div class="mb-2 mr-2">
                    <button class="btn btn-light" type="submit">
                        <i class="fa fa-search"></i> Поиск
                    </button>
                </div>
            </div>
        </form>
    </div>


    <div class="margin-between-above">
        <table class="table table-bordered table-hover">
            <thead>
                <tr>
                    <th>
                        <p>
                            Подразделение
                        </p>
                    </th>
                    <th>
                        <p>
                            Обход
                        </p>
                    </th>
                    <th>
                        <p>
                            Дата создания
                        </p>
                    </th>
                    <th>
                        <p>
                            Код тех. поз.
                        </p>
                    </th>
                    <th>
                        <p>
                            Код узла
                        </p>
                    </th>
                    <th>
                        <p>
                            Идентификатор Максимо
                        </p>
                    </th>
                    <th>
                        <p>
                            Статус
                        </p>
                    </th>
                    <th>
                        <p>
                            Изменить/Отправить
                        </p>
                    </th>
                </tr>
            </thead>
            <tbody>
                @if (ViewBag.Data == null)
                    return;
                else foreach (MaximoDefect item in ViewBag.Data)
                    {
                <tr>
                    <td>
                        <p>
                            @item.DepartmentName
                        </p>
                    </td>
                    <td>
                        <p>
                            @item.TaskName
                        </p>
                    </td>
                    <td>
                        <p>
                            @item.CreationTime.ToString()
                        </p>
                    </td>
                    <td>
                        <p>
                            @item.CustomAssetCode
                        </p>
                    </td>
                    <td>
                        <p>
                            @item.CustomAssetChildCode
                        </p>
                    </td>
                    <td>
                        <p>
                            @item.TICKETID
                        </p>
                    </td>
                    <td>
                        <p>
                            @item.MaximoStatus
                        </p>
                    </td>
                    <td>
                        <div class="d-flex justify-content-center">
                            
                            @if (item.MaximoStatusId == 1 || item.MaximoStatusId == 3)
                            {
                            <button type="button" class="btn btn-info mr-1" data-toggle="modal-toggler" data-target="#MaximoStatisticsEdit" data-url="@Url.Action("MaximoStatisticsEdit", new { id = item.Id })">
                                <i class="fa fa-pen"></i>
                            </button>
                            <button type="submit" class="btn btn-success ml-1" onclick="changesModalShow('@Url.Action("MaximoStatisticsSend", new { id = item.Id })', 'Отправка', 'Вы действительно хотите отправить данные в Maximo?');">
                                <i class="fa fa-share"></i>
                            </button>
                            }
                            else
                            {
                            <button type="button" class="btn btn-info mr-1" style="z-index:-1;" disabled="disabled">
                                <i class="fa fa-pen"></i>
                            </button>
                            <button type="submit" class="btn btn-success ml-1" style="z-index:-1;" disabled="disabled">
                                <i class="fa fa-share"></i>
                            </button>
                            }
                        </div>
                    </td>
                </tr>
}
            </tbody>
        </table>
    </div>
    <script type="text/javascript">


        $(document).ready(function () {
            InitializeDatePicker();
            //$.noConflict();
            $('#SetToday').click('click', SetTodayForTDTs);
        });
        function InitializeDatePicker() {

            @if (string.IsNullOrEmpty(Model.From))
            {
            <text>
                var d = new Date(moment().subtract(2, 'days'));
                var now = new Date(moment());
            </text>
            }
            else
            {
                <text>
                    var d = new Date(@Model.From);
                    var now = new Date(@Model.To);
                </text>
            }
            $('#datetimepickerFROM').datetimepicker({
                locale: 'ru',
                icons: {
                    time: "fa fa-clock",
                    date: "fa fa-calendar-alt",
                    up: "fa fa-arrow-up",
                    down: "fa fa-arrow-down"
                }
            });

            $('#datetimepickerFROM').on("change.datetimepicker", ({ date }) => { $('#From').val(date._d.getTime()); });
            $('#datetimepickerFROM').datetimepicker('date', new Date(d.getFullYear(), d.getMonth(), d.getDate()));

            $('#datetimepickerTO').datetimepicker({
                locale: 'ru',
                icons: {
                    time: "fa fa-clock",
                    date: "fa fa-calendar-alt",
                    up: "fa fa-arrow-up",
                    down: "fa fa-arrow-down"
                }
                });
            $("#datetimepickerTO").on("change.datetimepicker", ({ date }) => { $('#To').val(date._d.getTime()); });
            $('#datetimepickerTO').datetimepicker('date', now);
        }

        function SetTodayForTDTs() {

            var from = document.getElementById('DTPFROM');
            var date = new Date(new Date().getFullYear(), new Date().getMonth(), new Date().getDate());
            date.setDate(date.getDate() - 2);
            from.value = formatDate(date);

            var to = document.getElementById('DTPTO');
            var toDate = new Date(new Date().getFullYear(), new Date().getMonth(), new Date().getDate());
            toDate.setDate(toDate.getDate() + 1);
            to.value = formatDate(toDate);

            $('#From').val(date.getTime());
            $('#To').val(toDate.getTime());
        }

        function dateFromChanged({ date }) {
            $('#From').val(date._d.getTime());
        }

        function formatDate(date) {
            var month = date.getMonth()+1;
            var day = date.getDate();
            var year = date.getFullYear();
            var hours = date.getHours();
            var minutes = date.getMinutes();

            return ((day > 9 ? '' : '0') + day + '.' + (month > 9 ? '' : '0') + month + '.' + year + ' ' + hours + ':' + (minutes > 9 ? '' : '0') + minutes);
        }
    </script>
</section>
